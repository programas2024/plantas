<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plantas Medicinales</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.4.0/dist/confetti.browser.min.js"></script>
   
    <style>
        :root {
            --primary: #5697bd;
            --primary-light: #48cae4;
            --primary-dark: #1d7875;
            --secondary: #e9c46a;
            --secondary-light: #f4e8c9;
            --accent: #e76f51;
            --accent-light: #f8d7ce;
            --background: #f8f9fa;
            --card-background: #ffffff;
            --text-primary: #264653;
            --text-secondary: #6c757d;
            --text-light: #a0aec0;
            --border: #e2e8f0;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 10px 30px rgba(0, 0, 0, 0.12);
            --radius: 16px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header Styles - Mejorado para todas las pantallas */
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1.2rem 0;
            box-shadow: var(--shadow);
            position: relative;
            width: 100%;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .logo i {
            font-size: 1.8rem;
            color: var(--secondary);
        }

        .search-container {
            display: flex;
            gap: 12px;
            max-width: 600px;
            width: 100%;
            flex: 1;
        }

        .search-box {
            display: flex;
            flex: 1;
            background: white;
            border-radius: 50px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: var(--transition);
            min-width: 250px;
        }

        .search-box:focus-within {
            box-shadow: 0 0 0 3px rgba(42, 157, 143, 0.3);
        }

        .search-input {
            flex: 1;
            border: none;
            padding: 14px 20px;
            font-size: 1rem;
            outline: none;
            background: transparent;
        }

        .search-button {
            background: var(--secondary);
            border: none;
            padding: 0 22px;
            cursor: pointer;
            color: var(--text-primary);
            font-weight: 500;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .search-button:hover {
            background: #d9b45a;
        }

        .header-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .filter-toggle {
            background: white;
            color: var(--primary);
            border: none;
            border-radius: 50px;
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .filter-toggle:hover {
            background: #f0f0f0;
            transform: translateY(-2px);
        }

        .add-plant-btn {
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .add-plant-btn:hover {
            background: #d45a3f;
            transform: translateY(-2px);
        }

        .help-btn {
            background: var(--primary-light);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .help-btn:hover {
            background: #3ab7d8;
            transform: translateY(-2px);
        }

        /* Advanced Filters */
        .advanced-filters {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 25px;
            box-shadow: var(--shadow);
            transform: scaleY(0);
            transform-origin: top;
            height: 0;
            opacity: 0;
            transition: var(--transition);
        }

        .advanced-filters.active {
            transform: scaleY(1);
            height: auto;
            opacity: 1;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .filter-group label i {
            color: var(--primary);
        }

        .filter-group select {
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            background: white;
            transition: var(--transition);
            cursor: pointer;
        }

        .filter-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(42, 157, 143, 0.3);
        }

        /* Main Content */
        main {
            padding: 2.5rem 0;
            flex: 1;
        }

        .content-wrapper {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 35px;
            min-height: 600px;
        }

        @media (max-width: 1100px) {
            .content-wrapper {
                grid-template-columns: 1fr;
                gap: 25px;
            }
        }

        .map-container {
            height: 100%;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            position: relative;
            min-height: 400px;
        }

        #map {
            height: 100%;
            width: 100%;
            border-radius: var(--radius);
        }

        .map-legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            z-index: 1000;
            backdrop-filter: blur(5px);
            border: 1px solid var(--border);
        }

        .legend-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }

        .legend-user {
            background: #ff6b6b;
        }

        .legend-plant {
            background: #2a9d8f;
        }

        /* Contenedores de plantas mejorados */
        .plants-container-wrapper {
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background-color: var(--background);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 15px;
        }

        .plants-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            align-content: start;
            overflow-y: auto;
            padding: 15px;
            max-height: 100%;
            background-color: var(--card-background);
            border-radius: var(--radius);
        }

        /* Tarjetas de plantas elegantes */
        .plant-card {
            background: var(--card-background);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: var(--transition);
            cursor: pointer;
            position: relative;
            height: fit-content;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .plant-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
            border-color: var(--primary-light);
        }

        .plant-image {
            height: 200px;
            background-size: cover;
            background-position: center;
            position: relative;
            transition: var(--transition);
        }

        .plant-card:hover .plant-image {
            transform: scale(1.03);
        }

        .plant-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--accent);
            color: white;
            padding: 6px 14px;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(231, 111, 81, 0.3);
            z-index: 2;
        }

        .plant-info {
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .plant-name {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--text-primary);
            line-height: 1.3;
        }

        .plant-scientific {
            font-style: italic;
            color: var(--text-secondary);
            margin-bottom: 15px;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .plant-properties {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .property-tag {
            background: rgba(42, 157, 143, 0.15);
            color: var(--primary);
            padding: 6px 12px;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 500;
            transition: var(--transition);
            border: 1px solid rgba(42, 157, 143, 0.2);
        }

        .property-tag:hover {
            background: rgba(42, 157, 143, 0.25);
            transform: translateY(-2px);
        }

        .plant-region {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px dashed var(--border);
        }

        /* Estado cuando no hay plantas */
        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--primary-light);
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: var(--text-primary);
            font-weight: 600;
        }

        .empty-state p {
            margin-bottom: 20px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Barra de scroll elegante */
        .plants-container::-webkit-scrollbar {
            width: 8px;
        }

        .plants-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }

        .plants-container::-webkit-scrollbar-thumb {
            background: var(--primary-light);
            border-radius: 10px;
            border: 2px solid var(--card-background);
        }

        .plants-container::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        /* Efectos de carga */
        .plant-card.loading {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        /* Status Messages */
        .status-message {
            grid-column: 1 / -1;
            text-align: center;
            padding: 50px;
            font-size: 1.1rem;
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .error-message {
            color: var(--accent);
        }

        .loader {
            animation: spin 1s linear infinite;
            font-size: 2rem;
            color: var(--primary);
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .fade-in {
            opacity: 0;
            animation: fadeIn 0.5s ease forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        /* Footer mejorado y elegante */
        footer {
            background: white;
            padding: 2.5rem 0;
            text-align: center;
            margin-top: auto;
            border-top: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .footer-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 25px;
            flex-wrap: wrap;
        }

        .footer-links a {
            color: var(--primary);
            text-decoration: none;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 50px;
        }

        .footer-links a:hover {
            color: var(--primary-dark);
            background-color: var(--secondary-light);
            transform: translateY(-2px);
        }

        /* Admin Panel */
        .admin-panel {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            margin-top: 40px;
            box-shadow: var(--shadow);
            display: none;
        }

        .admin-panel.active {
            display: block;
        }

        .plant-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group label i {
            color: var(--primary);
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            transition: var(--transition);
            font-family: 'Poppins', sans-serif;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(42, 157, 143, 0.3);
        }

        .form-group textarea {
            min-height: 110px;
            resize: vertical;
        }

        .form-submit {
            grid-column: 1 / -1;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 15px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 15px;
        }

        .form-submit:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        /* Tooltips */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: var(--text-primary);
            color: white;
            text-align: center;
            border-radius: 8px;
            padding: 10px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85rem;
            font-weight: normal;
        }

        .tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--text-primary) transparent transparent transparent;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Guía de uso */
        .guide-container {
            background: var(--secondary-light);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 25px;
            border-left: 4px solid var(--secondary);
        }

        .guide-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .guide-steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .guide-step {
            background: white;
            padding: 15px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .guide-step:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
        }

        .guide-step h4 {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            color: var(--primary);
        }

        /* Formulario mejorado */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-section {
            background: var(--secondary-light);
            padding: 20px;
            border-radius: var(--radius);
            margin-bottom: 25px;
            border-left: 4px solid var(--primary);
        }

        .form-section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: var(--primary-dark);
            font-weight: 600;
        }

        /* Animaciones para nuevas plantas */
        @keyframes newPlant {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .plant-card.new-plant {
            animation: newPlant 0.5s ease forwards;
        }

        /* Separador entre grupos de plantas */
        .plants-group {
            margin-bottom: 30px;
        }

        .plants-group-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-light);
        }

        /* RESPONSIVE DESIGN */
        /* Pantallas pequeñas (500px) */
        @media (max-width: 500px) {
            .container {
                padding: 0 15px;
            }
            
            .header-content {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            
            .logo {
                font-size: 1.3rem;
                justify-content: center;
            }
            
            .search-container {
                flex-direction: column;
                max-width: 100%;
                gap: 10px;
            }
            
            .search-box {
                flex-direction: column;
                border-radius: var(--radius);
                min-width: auto;
            }
            
            .search-input {
                border-radius: var(--radius) var(--radius) 0 0;
            }
            
            .search-button {
                border-radius: 0 0 var(--radius) var(--radius);
                padding: 12px;
            }
            
            .header-buttons {
                width: 100%;
                justify-content: center;
            }
            
            .filter-toggle, .add-plant-btn, .help-btn {
                width: 100%;
                justify-content: center;
                margin-bottom: 8px;
            }
            
            .content-wrapper {
                gap: 20px;
            }
            
            .map-container {
                height: 350px;
            }
            
            .plants-container {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 10px;
            }
            
            .plant-info {
                padding: 18px;
            }
            
            .plant-name {
                font-size: 1.2rem;
            }
            
            .plant-form {
                grid-template-columns: 1fr;
            }
            
            .advanced-filters {
                grid-template-columns: 1fr;
                padding: 20px 15px;
            }
            
            .footer-links {
                flex-direction: column;
                gap: 15px;
            }
            
            .footer-links a {
                width: 100%;
                justify-content: center;
            }
            
            .footer-content p {
                font-size: 0.9rem;
            }
            
            .map-legend {
                bottom: 10px;
                left: 10px;
                padding: 10px;
                font-size: 0.8rem;
            }
            
            .status-message {
                padding: 30px 20px;
            }
            
            .guide-steps {
                grid-template-columns: 1fr;
            }
            
            .guide-container {
                padding: 15px;
            }
        }

        /* Pantallas medianas (501px - 768px) */
        @media (max-width: 768px) and (min-width: 501px) {
            .header-content {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-container {
                max-width: 100%;
            }
            
            .content-wrapper {
                gap: 25px;
            }
            
            .map-container {
                height: 400px;
            }
            
            .plants-container {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .plant-form {
                grid-template-columns: 1fr;
            }
            
            .advanced-filters {
                grid-template-columns: 1fr 1fr;
            }
            
            .footer-links {
                flex-wrap: wrap;
            }
            
            .footer-links a {
                padding: 6px 12px;
            }
        }

        /* Pantallas grandes (769px - 1100px) */
        @media (max-width: 1100px) and (min-width: 769px) {
            .content-wrapper {
                grid-template-columns: 1fr 1.2fr;
            }
            
            .plants-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            :root {
                --background: #1a202c;
                --card-background: #2d3748;
                --text-primary: #e2e8f0;
                --text-secondary: #a0aec0;
                --border: #4a5568;
            }
            
            .search-box,
            .advanced-filters,
            .admin-panel,
            .filter-toggle,
            .add-plant-btn,
            .help-btn,
            .filter-group select {
                background: #2d3748;
                color: var(--text-primary);
            }
            
            .search-input {
                background: #2d3748;
                color: var(--text-primary);
            }
            
            footer {
                background: #2d3748;
            }
            
            .form-section {
                background: #2d3748;
            }
            
            .guide-container {
                background: #2d3748;
            }
        }

        /* Animation for cards */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .plant-card {
            animation: slideIn 0.5s ease forwards;
        }

        /* SweetAlert customization */
        .swal2-popup {
            border-radius: var(--radius) !important;
            font-family: 'Poppins', sans-serif !important;
            padding: 2rem !important;
        }

        .swal2-title {
            font-size: 1.8rem !important;
            color: var(--text-primary) !important;
            font-weight: 700 !important;
        }

        .swal2-html-container {
            font-size: 1.05rem !important;
            color: var(--text-secondary) !important;
            line-height: 1.6 !important;
            text-align: left !important;
            max-height: 60vh !important;
            overflow-y: auto !important;
        }

        .swal2-confirm {
            background-color: var(--primary) !important;
            border-radius: 10px !important;
            padding: 12px 24px !important;
            font-size: 1.1rem !important;
            font-weight: 600 !important;
        }

        
        .swal2-image {
            border-radius: var(--radius) !important;
            margin: 1.5rem auto !important;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-leaf"></i>
                    <span>Plantas Medicinales</span>
                </div>
                
                <div class="search-container">
                    <div class="search-box">
                        <input type="text" id="searchInput" class="search-input" placeholder="Buscar plantas medicinales...">
                        <button id="searchButton" class="search-button">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    
                    <div class="header-buttons">
                        <button id="filterToggle" class="filter-toggle">
                            <i class="fas fa-filter"></i>
                            <span class="filter-text">Filtros</span>
                        </button>

                        <button id="addPlantBtn" class="add-plant-btn">
                            <i class="fas fa-plus"></i>
                            <span>Agregar</span>
                        </button>

                        <button id="helpBtn" class="help-btn">
                            <i class="fas fa-question-circle"></i>
                            <span>Ayuda</span>
                        </button>
                    </div>
                </div>
            </div>

            <div id="advancedFilters" class="advanced-filters">
                <div class="filter-group">
                    <label for="propertyFilter">
                        <i class="fas fa-heart"></i>
                        Propiedad medicinal
                        <div class="tooltip">
                            <i class="fas fa-question-circle" style="color: var(--text-light); font-size: 0.9rem;"></i>
                            <span class="tooltip-text">Filtra por las propiedades medicinales de las plantas</span>
                        </div>
                    </label>
                    <select id="propertyFilter">
                        <option value="">Todas las propiedades</option>
                        <option value="Digestiva">Digestiva</option>
                        <option value="Relajante">Relajante</option>
                        <option value="Antiinflamatoria">Antiinflamatoria</option>
                        <option value="Analgésica">Analgésica</option>
                        <option value="Cicatrizante">Cicatrizante</option>
                        <option value="Antiséptica">Antiséptica</option>
                        <option value="Expectorante">Expectorante</option>
                        <option value="Diurética">Diurética</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="zoneFilter">
                        <i class="fas fa-map-marker-alt"></i>
                        Región
                        <div class="tooltip">
                            <i class="fas fa-question-circle" style="color: var(--text-light); font-size: 0.9rem;"></i>
                            <span class="tooltip-text">Filtra por la región donde se encuentra la planta</span>
                        </div>
                    </label>
                    <select id="zoneFilter">
                        <option value="">Todas las regiones</option>
                        <option value="norte">Norte</option>
                        <option value="sur">Sur</option>
                        <option value="este">Este</option>
                        <option value="oeste">Oeste</option>
                        <option value="centro">Centro</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="altitudeFilter">
                        <i class="fas fa-mountain"></i>
                        Altitud
                        <div class="tooltip">
                            <i class="fas fa-question-circle" style="color: var(--text-light); font-size: 0.9rem;"></i>
                            <span class="tooltip-text">Filtra por el rango de altitud donde crece la planta</span>
                        </div>
                    </label>
                    <select id="altitudeFilter">
                        <option value="">Todos los rangos</option>
                        <option value="0-500">0-500 m</option>
                        <option value="500-1500">500-1500 m</option>
                        <option value="1500-3000">1500-3000 m</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="climateFilter">
                        <i class="fas fa-cloud-sun"></i>
                        Clima
                        <div class="tooltip">
                            <i class="fas fa-question-circle" style="color: var(--text-light); font-size: 0.9rem;"></i>
                            <span class="tooltip-text">Filtra por el tipo de clima donde crece la planta</span>
                        </div>
                    </label>
                    <select id="climateFilter">
                        <option value="">Todos los climas</option>
                        <option value="templado">Templado</option>
                        <option value="tropical">Tropical</option>
                        <option value="seco">Seco</option>
                        <option value="montañoso">Montañoso</option>
                        <option value="mediterráneo">Mediterráneo</option>
                    </select>
                </div>
            </div>
        </div>
    </header>
    
    <main class="container">
        <div id="adminForm" class="admin-panel">
            <h3><i class="fas fa-plus-circle"></i> Añadir Nueva Planta Medicinal</h3>
            
            <form id="plantForm" class="plant-form">
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="fas fa-info-circle"></i>
                        Información básica
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="common_name">
                                <i class="fas fa-signature"></i>
                                Nombre común
                            </label>
                            <input type="text" id="common_name" required placeholder="Ej: Manzanilla">
                        </div>
                        
                        <div class="form-group">
                            <label for="scientific_name">
                                <i class="fas fa-microscope"></i>
                                Nombre científico
                            </label>
                            <input type="text" id="scientific_name" required placeholder="Ej: Matricaria chamomilla">
                        </div>
                        
                        <div class="form-group">
                            <label for="image_url">
                                <i class="fas fa-image"></i>
                                URL de la imagen
                            </label>
                            <input type="url" id="image_url" required placeholder="https://ejemplo.com/imagen.jpg">
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="fas fa-map-marked-alt"></i>
                        Distribución y hábitat
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="distribution">
                                <i class="fas fa-globe-americas"></i>
                                Distribución
                            </label>
                            <input type="text" id="distribution" required placeholder="Regiones de Europa и Asia">
                        </div>
                        
                        <div class="form-group">
                            <label for="region">
                                <i class="fas fa-map-marker-alt"></i>
                                Región
                            </label>
                            <select id="region" required>
                                <option value="">Selecciona una región</option>
                                <option value="norte">Norte</option>
                                <option value="sur">Sur</option>
                                <option value="este">Este</option>
                                <option value="oeste">Oeste</option>
                                <option value="centro">Centro</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="altitude_range">
                                <i class="fas fa-mountain"></i>
                                Rango de altitud
                            </label>
                            <select id="altitude_range" required>
                                <option value="">Selecciona un rango</option>
                                <option value="0-500">0-500 m</option>
                                <option value="500-1500">500-1500 m</option>
                                <option value="1500-3000">1500-3000 m</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="climate_zones">
                                <i class="fas fa-cloud-sun"></i>
                                Zonas climáticas
                            </label>
                            <input type="text" id="climate_zones" required placeholder="templado, seco">
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="fas fa-heart"></i>
                        Propiedades medicinales
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="properties">
                                <i class="fas fa-heart"></i>
                                Propiedades (separadas por coma)
                            </label>
                            <input type="text" id="properties" required placeholder="Digestiva, Relajante, Antiinflamatoria">
                        </div>
                        
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="medicinal_uses">
                                <i class="fas fa-first-aid"></i>
                                Usos medicinales
                            </label>
                            <textarea id="medicinal_uses" placeholder="Describe los usos medicinales..."></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="fas fa-mortar-pestle"></i>
                        Preparación y precauciones
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="preparation_methods">
                                <i class="fas fa-mortar-pestle"></i>
                                Métodos de preparación
                            </label>
                            <textarea id="preparation_methods" placeholder="Describe cómo prepararla..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="precautions">
                                <i class="fas fa-exclamation-triangle"></i>
                                Precauciones
                            </label>
                            <textarea id="precautions" placeholder="Indica las precauciones necesarias..."></textarea>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="form-submit">
                    <i class="fas fa-save"></i> Guardar Planta
                </button>
            </form>
        </div>

        <!-- Guía de uso -->
        <div class="guide-container">
            <div class="guide-title">
                <i class="fas fa-info-circle" style="color: var(--primary); font-size: 1.5rem;"></i>
                <h3>¿Cómo usar esta aplicación?</h3>
            </div>
            <div class="guide-steps">
                <div class="guide-step">
                    <h4><i class="fas fa-search"></i> Búsqueda</h4>
                    <p>Usa la barra de búsqueda para encontrar plantas por nombre o propiedades medicinales.</p>
                </div>
                <div class="guide-step">
                    <h4><i class="fas fa-filter"></i> Filtros</h4>
                    <p>Aplica filtros para encontrar plantas por región, altitud, clima o propiedades específicas.</p>
                </div>
                <div class="guide-step">
                    <h4><i class="fas fa-map-marked-alt"></i> Mapa</h4>
                    <p>Explora las plantas en el mapa interactivo. Haz clic en los marcadores para ver detalles.</p>
                </div>
                <div class="guide-step">
                    <h4><i class="fas fa-plus-circle"></i> Agregar</h4>
                    <p>Añade nuevas plantas medicinales con el botón "Agregar Planta".</p>
                </div>
            </div>
        </div>

        <div class="content-wrapper">
            <div class="map-container">
                <div id="map"></div>
                <div class="map-legend">
                    <div class="legend-title">
                        <i class="fas fa-map-marked-alt"></i>
                        Leyenda del Mapa
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-user"></div>
                        <span>Tu ubicación</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-plant"></div>
                        <span>Plantas medicinales</span>
                    </div>
                </div>
            </div>
            
            <div class="plants-container-wrapper">
                <div id="plantsContainer" class="plants-container">
                    <div class="status-message">
                        <i class="fas fa-spinner loader"></i>
                        <span>Cargando plantas medicinales...</span>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <footer>
        <div class="container">
            <div class="footer-content">
                <p>Explora el mundo de las plantas medicinales y sus propiedades curativas</p>
                <div class="footer-links">
                    <a href="#">
                        <i class="fas fa-info-circle"></i> Acerca de
                    </a>
                    <a href="#">
                        <i class="fas fa-envelope"></i> Contacto
                    </a>
                    <a href="#">
                        <i class="fas fa-shield-alt"></i> Privacidad
                    </a>
                    <a href="#">
                        <i class="fas fa-question-circle"></i> Ayuda
                    </a>
                </div>
                <p>© 2023 Plantas Medicinales. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>
   <script>
    // Configuración de Supabase - VERIFICA ESTOS VALORES
    const SUPABASE_URL = 'https://dltnrcmhopkfgkmupjbl.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRsdG5yY21ob3BrZmdrbXVwamJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3NzAwNjEsImV4cCI6MjA3MjM0NjA2MX0.adlL3LhGncIunjlM56GnozbC6caSW_H_0azZ9tgywtI';
    
    // Inicializar Supabase
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Variables globales
    let map, userLocationMarker, userLocation;
    let allPlants = [];
    let plantMarkers = [];

    // Función para mostrar ayuda de la aplicación
    function showHelp() {
        Swal.fire({
            title: '¿Cómo usar Plantas Medicinales?',
            html: `
                <div style="text-align: left; line-height: 1.8;">
                    <p><strong>Esta aplicación te permite:</strong></p>
                    <ul>
                        <li>🌿 <strong>Buscar plantas medicinales</strong> por nombre o propiedades</li>
                        <li>🔍 <strong>Filtar plantas</strong> por región, altitud, clima o propiedades específicas</li>
                        <li>🗺️ <strong>Visualizar en un mapa</strong> la ubicación de las plantas</li>
                        <li>➕ <strong>Agregar nuevas plantas</strong> a la base de datos</li>
                        <li>ℹ️ <strong>Ver información detallada</strong> sobre cada planta medicinal</li>
                    </ul>
                    
                    <p><strong>Para buscar:</strong> Escribe en la barra de búsqueda y presiona Enter o el botón de búsqueda.</p>
                    
                    <p><strong>Para filtrar:</strong> Haz clic en "Filtros" y selecciona los criterios deseados.</p>
                    
                    <p><strong>Para ver detalles:</strong> Haz clic en cualquier tarjeta de planta o marcador del mapa.</p>
                    
                    <p><strong>Para agregar plantas:</strong> Usa el botón "Agregar Planta" y completa el formulario.</p>
                </div>
            `,
            icon: 'info',
            confirmButtonText: 'Entendido',
            width: '800px',
            background: 'var(--card-background)',
            color: 'var(--text-primary)',
            customClass: {
                confirmButton: 'swal2-confirm'
            }
        });
    }

    // Función principal para buscar plantas
    async function searchPlants(query = '', filters = {}) {
        const plantsContainer = document.getElementById('plantsContainer');
        plantsContainer.innerHTML = `
            <div class="status-message">
                <i class="fas fa-spinner loader"></i>
                <span>Buscando plantas...</span>
            </div>
        `;
        
        try {
            // Primero intentamos cargar desde Supabase
            let supabaseQuery = supabase
                .from('medicinal_plants')
                .select('*')
                .order('common_name', { ascending: true });
            
            // Aplicar filtro de búsqueda de texto
            if (query && query.trim() !== '') {
                supabaseQuery = supabaseQuery.or(`common_name.ilike.%${query}%,scientific_name.ilike.%${query}%`);
            }
            
            // Aplicar filtros adicionales solo si tienen valor
            if (filters.region && filters.region !== '') {
                supabaseQuery = supabaseQuery.eq('region', filters.region);
            }
            
            if (filters.altitude && filters.altitude !== '') {
                supabaseQuery = supabaseQuery.eq('altitude_range', filters.altitude);
            }
            
            if (filters.property && filters.property !== '') {
                // Para propiedades, usamos el operador de contención para arrays
                supabaseQuery = supabaseQuery.contains('properties', [filters.property]);
            }
            
            if (filters.climate && filters.climate !== '') {
                // Para zonas climáticas, también usamos el operador de contención para arrays
                supabaseQuery = supabaseQuery.contains('climate_zones', [filters.climate]);
            }
            
            const { data: plants, error } = await supabaseQuery;
            
            if (error) {
                console.error('Error de Supabase:', error);
                // Si hay error de autenticación (401), saltar directamente a Trefle
                if (error.code === 'PGRST301' || error.message.includes('401')) {
                    throw new Error('Error de autenticación con Supabase');
                }
                throw error;
            }
            
            if (plants && plants.length > 0) {
                allPlants = plants;
                displayPlants(allPlants, false);
                updateMapWithPlants(allPlants, false);
                
                // Mostrar confetti si hay resultados
                if (plants.length > 0) {
                    confetti({
                        particleCount: 100,
                        spread: 70,
                        origin: { y: 0.6 }
                    });
                }
            } else {
                // Si no hay resultados en Supabase, buscar en Trefle
                plantsContainer.innerHTML = `
                    <div class="status-message">
                        <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 15px;"></i>
                        <span>No se encontraron plantas en nuestra base de datos. Buscando en Trefle...</span>
                    </div>
                `;
                
                // Buscar en la API de Trefle
                await searchTreflePlants(query);
            }
        } catch (error) {
            console.error('Error buscando plantas:', error);
            plantsContainer.innerHTML = `
                <div class="status-message">
                    <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 15px;"></i>
                    <span>Error al conectar con nuestra base de datos. Buscando en Trefle...</span>
                </div>
            `;
            
            // Intentar buscar en Trefle como último recurso
            setTimeout(() => {
                searchTreflePlants(query);
            }, 1500);
        }
    }

    // Función para buscar plantas en la API de Trefle usando Netlify Function
    async function searchTreflePlants(query) {
        const plantsContainer = document.getElementById('plantsContainer');
        
        if (!query || query.trim() === '') {
            plantsContainer.innerHTML = `
                <div class="status-message">
                    <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 15px;"></i>
                    <span>Ingresa un término de búsqueda para buscar en Trefle.</span>
                </div>
            `;
            allPlants = [];
            updateMapWithPlants([], false);
            return;
        }
        
        try {
            plantsContainer.innerHTML = `
                <div class="status-message">
                    <i class="fas fa-spinner loader"></i>
                    <span>Buscando "${query}" en Trefle...</span>
                </div>
            `;
            
            // Usar Netlify Function como proxy para Trefle
            const response = await fetch(`/.netlify/functions/trefle-proxy?q=${encodeURIComponent(query)}`);
            
            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data && data.data && data.data.length > 0) {
                // Convertir los datos de Trefle al formato de nuestra aplicación
                const treflePlants = data.data.map((plant, index) => {
                    // Generar coordenadas aleatorias cerca del usuario para el mapa
                    const offsetLat = userLocation ? (Math.random() - 0.5) * 0.5 : (Math.random() - 0.5);
                    const offsetLng = userLocation ? (Math.random() - 0.5) * 0.5 : (Math.random() - 0.5);
                    
                    // Obtener información específica de la planta o usar valores por defecto
                    const plantInfo = getPlantSpecificInfo(plant.common_name || plant.scientific_name || query);
                    
                    return {
                        id: plant.id || Date.now() + index,
                        common_name: plant.common_name || query.charAt(0).toUpperCase() + query.slice(1),
                        scientific_name: plant.scientific_name || 'Nombre científico no disponible',
                        image_url: plant.image_url || plantInfo.image_url,
                        properties: plantInfo.properties,
                        distribution: plant.distribution || plantInfo.distribution,
                        region: plantInfo.region,
                        altitude_range: plantInfo.altitude_range,
                        climate_zones: plantInfo.climate_zones,
                        description: plantInfo.description,
                        medicinal_uses: plantInfo.medicinal_uses,
                        preparation_methods: plantInfo.preparation_methods,
                        precautions: plantInfo.precautions,
                        // Coordenadas para el mapa
                        latitude: userLocation ? userLocation.lat + offsetLat : 40.41 + offsetLat,
                        longitude: userLocation ? userLocation.lng + offsetLng : -3.70 + offsetLng,
                        fromTrefle: true // Marcar como planta de Trefle
                    };
                });
                
                allPlants = treflePlants;
                displayPlants(treflePlants, true);
                updateMapWithPlants(treflePlants, true);
                
                // Mostrar mensaje indicando que son resultados de Trefle
                if (treflePlants.length > 0) {
                    Swal.fire({
                        title: 'Resultados de Trefle',
                        text: `Se encontraron ${treflePlants.length} plantas en la base de datos de Trefle.`,
                        icon: 'info',
                        confirmButtonText: 'Entendido'
                    });
                }
            } else {
                plantsContainer.innerHTML = `
                    <div class="status-message">
                        <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 15px;"></i>
                        <span>No se encontraron plantas en Trefle para "${query}".</span>
                    </div>
                `;
                allPlants = [];
                updateMapWithPlants([], false);
            }
        } catch (error) {
            console.error('Error buscando en Trefle:', error);
            plantsContainer.innerHTML = `
                <div class="status-message">
                    <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 15px;"></i>
                    <span>Error al conectar con Trefle. Cargando plantas de ejemplo...</span>
                </div>
            `;
            
            // Mostrar plantas de ejemplo como último recurso
            setTimeout(() => {
                loadExamplePlants();
            }, 1500);
        }
    }

    // Función para obtener información específica de plantas comunes
    function getPlantSpecificInfo(plantName) {
        const plantLower = (plantName || '').toLowerCase();
        
        // Base de datos de información específica para plantas comunes
        const plantsInfo = {
            'canela': {
                properties: ["Antioxidante", "Antiinflamatoria", "Antimicrobiana", "Reguladora de glucosa"],
                distribution: "Sri Lanka, India, Indonesia",
                region: "tropical",
                altitude_range: "0-500",
                climate_zones: ["tropical", "subtropical"],
                description: "La canela es una especia obtenida de la corteza interna de varios árboles del género Cinnamomum. Se utiliza ampliamente en la medicina tradicional por sus múltiples propiedades beneficiosas para la salud.",
                medicinal_uses: "Regulación de azúcar en sangre, mejora de la digestión, reducción de inflamación, tratamiento de infecciones respiratorias y propiedades antioxidantes.",
                preparation_methods: "Infusión con una rama de canela por taza de agua hirviendo. Polvo de canela añadido a alimentos. Aceite esencial para uso tópico.",
                precautions: "Evitar dosis altas durante el embarazo. Puede interactuar con medicamentos para diabetes. Algunas personas pueden ser alérgicas.",
                image_url: "https://images.unsplash.com/photo-1517686469429-8bdb88b9f907?ixlib=rb-4.0.3"
            },
            'cidron': {
                properties: ["Digestiva", "Relajante", "Carminativa", "Antiespasmódica"],
                distribution: "América del Sur, cultivada en regiones templadas",
                region: "sur",
                altitude_range: "0-1500",
                climate_zones: ["templado", "subtropical"],
                description: "El cidrón o hierba luisa es un arbusto aromático originario de América del Sur. Sus hojas desprenden un intenso aroma a limón y se utilizan ampliamente en la medicina tradicional por sus propiedades digestivas y relajantes.",
                medicinal_uses: "Alivia problemas digestivos, cólicos, flatulencias, ansiedad, insomnio y estrés. También se usa como calmante nervioso.",
                preparation_methods: "Infusión con 5-10 hojas frescas o secas por litro de agua. Dejar reposar 5-10 minutos. Se puede endulzar con miel.",
                precautions: "Evitar durante el embarazo y lactancia. No exceder la dosis recomendada.",
                image_url: "https://images.unsplash.com/photo-1587049633312-d628ae50a8ae?ixlib=rb-4.0.3"
            },
            'sauco': {
                properties: ["Antiviral", "Expectorante", "Inmunoestimulante", "Antiinflamatorio"],
                distribution: "Europa, Asia noroccidental y África noroccidental",
                region: "norte",
                altitude_range: "0-1000",
                climate_zones: ["templado"],
                description: "El saúco es un arbusto caducifolio cuyas flores y bayas se utilizan con fines medicinales. Es conocido por sus propiedades para combatir resfriados y gripes.",
                medicinal_uses: "Tratamiento de resfriados, gripes, fiebre, sinusitis y afecciones respiratorias. Fortalece el sistema inmunológico.",
                preparation_methods: "Infusión de flores (5g por taza). Jarabe de bayas cocidas (las bayas deben cocinarse siempre).",
                precautions: "Las bayas crudas son tóxicas. Solo consumir bayas cocidas. Evitar durante el embarazo.",
                image_url: "https://images.unsplash.com/photo-1597848212620-7c7d5f2b48fe?ixlib=rb-4.0.3"
            },
            'manzanilla': {
                properties: ["Digestiva", "Relajante", "Antiinflamatoria", "Antiespasmódica"],
                distribution: "Europa y Asia",
                region: "norte",
                altitude_range: "0-500",
                climate_zones: ["templado"],
                description: "La manzanilla es una planta herbácea anual muy apreciada por sus propiedades calmantes y digestivas. Sus flores se utilizan para preparar infusiones.",
                medicinal_uses: "Alivia problemas digestivos, gastritis, cólicos, ansiedad, insomnio e irritaciones de la piel.",
                preparation_methods: "Infusión con 1 cucharada de flores secas por taza de agua hirviendo. Dejar reposar 5 minutos.",
                precautions: "Personas alérgicas a las asteráceas deben evitarla. Puede interactuar con anticoagulantes.",
                image_url: "https://images.unsplash.com/photo-1597848212620-7c7d5f2b48fe?ixlib=rb-4.0.3"
            },
            'menta': {
                properties: ["Digestiva", "Refrescante", "Analgésica", "Descongestionante"],
                distribution: "Regiones templadas de todo el mundo",
                region: "sur",
                altitude_range: "0-500",
                climate_zones: ["templado"],
                description: "La menta es una hierba aromática perenne muy popular por su efecto refrescante. Se utiliza tanto en gastronomía como en medicina tradicional.",
                medicinal_uses: "Alivia indigestión, náuseas, dolor de cabeza, congestión respiratoria y síndrome del intestino irritable.",
                preparation_methods: "Infusión con hojas frescas o secas. Inhalación de vapores para congestión. Uso tópico para dolores musculares.",
                precautions: "Evitar en niños pequeños. Puede causar acidez en algunas personas. No usar en casos de reflujo severo.",
                image_url: "https://images.unsplash.com/photo-1587049633312-d628ae50a8ae?ixlib=rb-4.0.3"
            },
            'aloe': {
                properties: ["Cicatrizante", "Hidratante", "Antiinflamatoria", "Laxante"],
                distribution: "Península arábiga y África",
                region: "este",
                altitude_range: "0-500",
                climate_zones: ["tropical", "seco"],
                description: "El aloe vera es una planta suculenta conocida por el gel transparente de sus hojas, que tiene múltiples propiedades medicinales y cosméticas.",
                medicinal_uses: "Quemaduras, heridas, psoriasis, acné, estreñimiento y problemas digestivos. Hidratante natural para la piel.",
                preparation_methods: "Aplicación directa del gel sobre la skin, o consumo del jugo para problemas digestivos.",
                precautions: "No consumir la parte verde de la hoja (látex) que es laxante fuerte. Consultar con médico durante embarazo.",
                image_url: "https://images.unsplash.com/photo-1593483316242-27ac42b70473?ixlib=rb-4.0.3"
            },
            'romero': {
                properties: ["Estimulante", "Antioxidante", "Antiinflamatorio", "Circulatorio"],
                distribution: "Región mediterránea",
                region: "oeste",
                altitude_range: "0-1500",
                climate_zones: ["mediterráneo"],
                description: "El romero es un arbusto aromático perenne originario del Mediterráneo. Sus hojas se utilizan como condimento y con fines medicinales.",
                medicinal_uses: "Mejora la memoria y concentración, alivia dolores musculares, estimula la circulación y tiene propiedades antioxidantes.",
                preparation_methods: "Infusión de hojas secas. Aceite esencial para masajes. Tintura para uso externo. Inhalaciones.",
                precautions: "Evitar dosis altas durante embarazo. El aceite esencial puro puede ser irritante para la piel.",
                image_url: "https://images.unsplash.com/photo-1587049633312-d628ae50a8ae?ixlib=rb-4.0.3"
            },
            'tomate': {
                properties: ["Antioxidante", "Antiinflamatorio", "Digestivo", "Hidratante"],
                distribution: "América del Sur, cultivado mundialmente",
                region: "sur",
                altitude_range: "0-2000",
                climate_zones: ["templado", "subtropical"],
                description: "El tomate es una fruta ampliamente cultivada y consumida, conocida por su alto contenido de licopeno, un potente antioxidante.",
                medicinal_uses: "Mejora la salud cardiovascular, protege la piel, favorece la digestión y tiene propiedades diuréticas.",
                preparation_methods: "Consumo crudo en ensaladas, jugos, salsas o cocido en diversos platillos.",
                precautions: "Personas con problemas de acidez deben consumirlo con moderación. Algunas personas pueden ser alérgicas.",
                image_url: "https://images.unsplash.com/photo-1561136594-7f68413baa99?ixlib=rb-4.0.3"
            },
            'default': {
                properties: ["Medicinal"],
                distribution: "Distribución global",
                region: "desconocida",
                altitude_range: "0-500",
                climate_zones: ["templado"],
                description: "Planta medicinal con diversas propiedades beneficiosas para la salud.",
                medicinal_uses: "Usos medicinales tradicionales.",
                preparation_methods: "Consulta con un especialista para métodos de preparación adecuados.",
                precautions: "Precauciones generales para plantas medicinales.",
                image_url: "https://images.unsplash.com/photo-1597848212620-7c7d5f2b48fe?ixlib=rb-4.0.3"
            }
        };
        
        // Buscar coincidencias parciales en los nombres de plantas
        for (const key in plantsInfo) {
            if (plantLower.includes(key)) {
                return plantsInfo[key];
            }
        }
        
        return plantsInfo['default'];
    }

    // Cargar plantas de ejemplo si Supabase falla
    function loadExamplePlants() {
        const examplePlants = [
            {
                id: 1,
                common_name: "Manzanilla",
                scientific_name: "Matricaria chamomilla",
                image_url: "https://images.unsplash.com/photo-1597848212620-7c7d5f2b48fe?ixlib=rb-4.0.3",
                properties: ["Digestiva", "Relajante", "Antiinflamatoria"],
                distribution: "Amplia distribución en Europa y Asia",
                region: "norte",
                altitude_range: "500-1500",
                climate_zones: ["templado"],
                description: "La manzanilla es conocida por sus propiedades calmantes y se utiliza comúnmente para aliviar problemas digestivos y promover la relajación.",
                medicinal_uses: "Infusión para problemas digestivos, ansiedad e irritaciones de la piel.",
                preparation_methods: "Infusión con 1 cucharada de flores secas por taza de agua hirviendo, dejar reposar 5 minutos.",
                precautions: "Puede causar reacciones alérgicas en personas sensibles a las plantas de la familia de las margaritas."
            },
            {
                id: 2,
                common_name: "Menta",
                scientific_name: "Mentha spicata",
                image_url: "https://images.unsplash.com/photo-1587049633312-d628ae50a8ae?ixlib=rb-4.0.3",
                properties: ["Digestiva", "Refrescante", "Analgésica"],
                distribution: "Regiones templadas de todo el mundo",
                region: "sur",
                altitude_range: "0-500",
                climate_zones: ["templado"],
                description: "La menta es una hierba aromática muy popular por su efecto refrescante y su capacidad para aliviar problemas digestivos.",
                medicinal_uses: "Alivio de indigestión, náuseas, dolor de cabeza y congestión respiratoria.",
                preparation_methods: "Infusión con hojas frescas o secas, inhalación de vapores para congestión.",
                precautions: "Evitar en niños pequeños y en casos de reflujo gastroesofágico severo."
            },
            {
                id: 3,
                common_name: "Aloe Vera",
                scientific_name: "Aloe barbadensis miller",
                image_url: "https://images.unsplash.com/photo-1593483316242-27ac42b70473?ixlib=rb-4.0.3",
                properties: ["Cicatrizante", "Hidratante", "Antiinflamatoria"],
                distribution: "Regiones tropicales y subtropicales",
                region: "este",
                altitude_range: "0-500",
                climate_zones: ["tropical"],
                description: "El aloe vera es conocido por sus propiedades regenerativas para la piel y su capacidad para aliviar quemaduras y irritaciones.",
                medicinal_uses: "Quemaduras, heridas, psoriasis, acné y problemas digestivos en forma de jugo.",
                preparation_methods: "Aplicación directa del gel de la hoja sobre la piel, o consumo del jugo para problemas digestivos.",
                precautions: "No consumir la parte verde de la hoja, solo el gel transparente interior."
            },
            {
                id: 4,
                common_name: "Sáuco",
                scientific_name: "Sambucus nigra",
                image_url: "https://images.unsplash.com/photo-1587049633312-d628ae50a8ae?ixlib=rb-4.0.3",
                properties: ["Antiviral", "Expectorante", "Inmunoestimulante"],
                distribution: "Regiones templadas de Europa y América",
                region: "norte",
                altitude_range: "0-1500",
                climate_zones: ["templado"],
                description: "El sáuco es conocido por sus propiedades antivirales y se utiliza comúnmente para aliviar síntomas de resfriados y gripes.",
                medicinal_uses: "Jarabe para resfriados, gripes y afecciones respiratorias.",
                preparation_methods: "Infusión de flores o bayas, jarabe de bayas cocidas con miel.",
                precautions: "No consumir bayas crudas ya que pueden ser tóxicas. Solo usar bayas cocidas."
            }
        ];
        
        allPlants = examplePlants;
        displayPlants(examplePlants, false);
        updateMapWithPlants(examplePlants, false);
        
        // Mostrar mensaje informativo
        Swal.fire({
            title: 'Plantas de ejemplo',
            text: 'Se están mostrando plantas de ejemplo debido a problemas de conexión.',
            icon: 'info',
            confirmButtonText: 'Entendido'
        });
    }

    // Función para mostrar plantas en la interfaz
    function displayPlants(plants, fromTrefle = false) {
        const plantsContainer = document.getElementById('plantsContainer');
        
        if (plants.length === 0) {
            plantsContainer.innerHTML = `
                <div class="status-message">
                    <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 15px;"></i>
                    <span>No se encontraron plantas que coincidan con tu búsqueda.</span>
                </div>
            `;
            return;
        }
        
        plantsContainer.innerHTML = '';
        
        plants.forEach((plant, index) => {
            const plantCard = document.createElement('div');
            plantCard.className = 'plant-card fade-in';
            plantCard.style.animationDelay = `${index * 0.1}s`;
            plantCard.onclick = () => showPlantDetails(plant);
            
            const imageUrl = plant.image_url || 'https://images.unsplash.com/photo-1597848212620-7c7d5f2b48fe?ixlib=rb-4.0.3';
            
            plantCard.innerHTML = `
                <div class="plant-image" style="background-image: url('${imageUrl}')">
                    <div class="plant-badge ${fromTrefle ? 'trefle-badge' : ''}">${fromTrefle ? 'Trefle' : 'Medicinal'}</div>
                </div>
                <div class="plant-info">
                    <div class="plant-name">${plant.common_name || 'Planta sin nombre común'}</div>
                    <div class="plant-scientific">${plant.scientific_name || 'Nombre científico no disponible'}</div>
                    <div class="plant-properties">
                        ${plant.properties && Array.isArray(plant.properties) ? 
                            plant.properties.map(prop => `<span class="property-tag">${prop}</span>`).join('') : 
                            '<span class="property-tag">Medicinal</span>'
                        }
                    </div>
                    <div class="plant-region">
                        <i class="fas fa-map-marker-alt"></i>
                        ${plant.region ? `Región ${plant.region.charAt(0).toUpperCase() + plant.region.slice(1)}` : 'Región no especificada'}
                    </div>
                    ${fromTrefle ? `
                        <div class="trefle-source">
                            <i class="fas fa-external-link-alt"></i>
                            <span>Información proporcionada por Trefle</span>
                        </div>
                    ` : ''}
                </div>
            `;
            
            plantsContainer.appendChild(plantCard);
        });
    }

    // Mostrar detalles de la planta
    function showPlantDetails(plant) {
        Swal.fire({
            title: plant.common_name || 'Planta Medicinal',
            html: `
                <div style="text-align: left;">
                    ${plant.fromTrefle ? `<p style="color: #9b59b6; font-weight: bold;"><i class="fas fa-external-link-alt"></i> Información proporcionada por Trefle</p>` : ''}
                    <p><strong>Nombre científico:</strong> ${plant.scientific_name || 'No disponible'}</p>
                    <p><strong>Propiedades:</strong> ${plant.properties ? (Array.isArray(plant.properties) ? plant.properties.join(', ') : plant.properties) : 'Medicinal'}</p>
                    <p><strong>Distribución:</strong> ${plant.distribution || 'No disponible'}</p>
                    <p><strong>Región:</strong> ${plant.region ? plant.region.charAt(0).toUpperCase() + plant.region.slice(1) : 'No especificada'}</p>
                    <p><strong>Rango de altitud:</strong> ${plant.altitude_range || 'No especificado'}</p>
                    <p><strong>Zonas climáticas:</strong> ${plant.climate_zones ? (Array.isArray(plant.climate_zones) ? plant.climate_zones.join(', ') : plant.climate_zones) : 'No especificado'}</p>
                    ${plant.description ? `<p><strong>Descripción:</strong> ${plant.description}</p>` : ''}
                    ${plant.medicinal_uses ? `<p><strong>Usos medicinales:</strong> ${plant.medicinal_uses}</p>` : ''}
                    ${plant.preparation_methods ? `<p><strong>Métodos de preparación:</strong> ${plant.preparation_methods}</p>` : ''}
                    ${plant.precautions ? `<p><strong>Precauciones:</strong> ${plant.precautions}</p>` : ''}
                </div>
            `,
            imageUrl: plant.image_url || 'https://images.unsplash.com/photo-1597848212620-7c7d5f2b48fe?ixlib=rb-4.0.3',
            imageWidth: 300,
            imageHeight: 200,
            imageAlt: plant.common_name,
            confirmButtonText: 'Cerrar',
            background: 'var(--card-background)',
            color: 'var(--text-primary)',
            confirmButtonColor: 'var(--primary)',
            width: '700px'
        });
    }

    // Inicializar el mapa
    function initMap() {
        map = L.map('map').setView([40.416775, -3.703790], 5);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        getUserLocation();
    }

    // Obtener la ubicación del usuario
    function getUserLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    map.setView([userLocation.lat, userLocation.lng], 10);
                    
                    if (userLocationMarker) {
                        map.removeLayer(userLocationMarker);
                    }
                    
                    // Crear un icono personalizado para la ubicación del usuario
                    const userIcon = L.divIcon({
                        className: 'user-location-marker',
                        html: '<div style="background-color: #ff6b6b; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3);"></div>',
                        iconSize: [22, 22],
                        iconAnchor: [11, 11]
                    });
                    
                    userLocationMarker = L.marker([userLocation.lat, userLocation.lng], {icon: userIcon})
                        .addTo(map)
                        .bindPopup('<b>Tu ubicación actual</b>')
                        .openPopup();
                        
                    searchPlants();
                },
                function(error) {
                    console.log('No se pudo obtener tu ubicación. Usando ubicación por defecto.');
                    searchPlants();
                },
                { timeout: 10000 }
            );
        } else {
            console.log('La geolocalización no es compatible con tu navegador.');
            searchPlants();
        }
    }

    // Actualizar el mapa con las plantas
    function updateMapWithPlants(plants, fromTrefle = false) {
        // Limpiar marcadores anteriores (excepto el del usuario)
        plantMarkers.forEach(marker => {
            map.removeLayer(marker);
        });
        plantMarkers = [];
        
        // Crear un icono personalizado para las plantas
        const plantIcon = L.divIcon({
            className: 'plant-marker',
            html: `<div style="background-color: ${fromTrefle ? '#9b59b6' : '#2a9d8f'}; width: 14px; height: 14px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3);"></div>`,
            iconSize: [20, 20],
            iconAnchor: [10, 10]
        });
        
        plants.forEach(plant => {
            const offsetLat = (Math.random() - 0.5) * 0.5;
            const offsetLng = (Math.random() - 0.5) * 0.5;
            
            const plantLat = plant.latitude || (userLocation ? userLocation.lat + offsetLat : 40.41 + offsetLat);
            const plantLng = plant.longitude || (userLocation ? userLocation.lng + offsetLng : -3.70 + offsetLng);
            
            const marker = L.marker([plantLat, plantLng], {icon: plantIcon}).addTo(map);
            
            // Crear un botón personalizado para el popup
            const popupContent = document.createElement('div');
            popupContent.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 5px; color: ${fromTrefle ? '#9b59b6' : '#2a9d8f'}; font-size: 1.1rem;">${plant.common_name || 'Planta medicinal'}</div>
                <div><i>${plant.scientific_name || 'Nombre científico no disponible'}</i></div>
                ${fromTrefle ? '<div style="font-size: 0.8rem; margin-top: 5px; color: #666;">(Desde Trefle)</div>' : ''}
                <button style="margin-top: 8px; padding: 8px 16px; background: ${fromTrefle ? '#9b59b6' : '#2a9d8f'}; color: white; border: none; border-radius: 6px; cursor: pointer; width: 100%;">
                    Ver detalles
                </button>
            `;
            
            const button = popupContent.querySelector('button');
            button.onclick = (e) => {
                e.stopPropagation();
                showPlantDetails(plant);
            };
            
            marker.bindPopup(popupContent);
            plantMarkers.push(marker);
        });
    }

    // Función para añadir una nueva planta a Supabase
    async function addPlant(plantData) {
        try {
            // Convertir propiedades y zonas climáticas a arrays
            plantData.properties = plantData.properties.split(',').map(item => item.trim());
            plantData.climate_zones = plantData.climate_zones.split(',').map(item => item.trim());
            
            const { data, error } = await supabase
                .from('medicinal_plants')
                .insert([plantData])
                .select();
            
            if (error) {
                console.error('Error insertando planta:', error);
                Swal.fire('Error', 'No se pudo guardar la planta: ' + error.message, 'error');
                return;
            }
            
            Swal.fire('Éxito', 'Planta añadida correctamente', 'success');
            document.getElementById('plantForm').reset();
            
            // Ocultar panel de administración
            document.getElementById('adminForm').classList.remove('active');
            document.getElementById('addPlantBtn').innerHTML = '<i class="fas fa-plus"></i> <span>Agregar Planta</span>';
            
            // Recargar las plantas
            performSearch();
            
        } catch (error) {
            console.error('Error añadiendo planta:', error);
            Swal.fire('Error', 'Ocurrió un error inesperado: ' + error.message, 'error');
        }
    }

    // Inicializar la aplicación
    window.onload = function() {
        initMap();
        
        // Toggle de filtros avanzados
        const filterToggle = document.getElementById('filterToggle');
        const advancedFilters = document.getElementById('advancedFilters');
        
        filterToggle.addEventListener('click', function() {
            advancedFilters.classList.toggle('active');
            
            if (advancedFilters.classList.contains('active')) {
                filterToggle.innerHTML = '<i class="fas fa-times"></i> <span class="filter-text">Cerrar Filtros</span>';
            } else {
                filterToggle.innerHTML = '<i class="fas fa-filter"></i> <span class="filter-text">Filtros</span>';
            }
        });
        
        // Botón para agregar plantas
        const addPlantBtn = document.getElementById('addPlantBtn');
        const adminForm = document.getElementById('adminForm');
        
        addPlantBtn.addEventListener('click', function() {
            adminForm.classList.toggle('active');
            
            if (adminForm.classList.contains('active')) {
                addPlantBtn.innerHTML = '<i class="fas fa-times"></i> <span>Cerrar Formulario</span>';
            } else {
                addPlantBtn.innerHTML = '<i class="fas fa-plus"></i> <span>Agregar Planta</span>';
            }
        });
        
        // Botón de ayuda
        const helpBtn = document.getElementById('helpBtn');
        helpBtn.addEventListener('click', showHelp);
        
        // Event listeners para búsqueda
        const searchButton = document.getElementById('searchButton');
        const searchInput = document.getElementById('searchInput');
        
        searchButton.addEventListener('click', function() {
            performSearch();
        });
        
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
        
        // Función para realizar la búsqueda con todos los filtros
        function performSearch() {
            const query = searchInput.value;
            const filters = {
                property: document.getElementById('propertyFilter').value,
                region: document.getElementById('zoneFilter').value,
                altitude: document.getElementById('altitudeFilter').value,
                climate: document.getElementById('climateFilter').value
            };
            
            searchPlants(query, filters);
        }
        
        // Event listeners para filtros
        document.getElementById('zoneFilter').addEventListener('change', performSearch);
        document.getElementById('altitudeFilter').addEventListener('change', performSearch);
        document.getElementById('propertyFilter').addEventListener('change', performSearch);
        document.getElementById('climateFilter').addEventListener('change', performSearch);
        
        // Formulario para añadir plantas
        document.getElementById('plantForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const plantData = {
                common_name: document.getElementById('common_name').value,
                scientific_name: document.getElementById('scientific_name').value,
                image_url: document.getElementById('image_url').value,
                properties: document.getElementById('properties').value,
                distribution: document.getElementById('distribution').value,
                region: document.getElementById('region').value,
                altitude_range: document.getElementById('altitude_range').value,
                climate_zones: document.getElementById('climate_zones').value,
                description: document.getElementById('description').value,
                medicinal_uses: document.getElementById('medicinal_uses').value,
                preparation_methods: document.getElementById('preparation_methods').value,
                precautions: document.getElementById('precautions').value
            };
            
            addPlant(plantData);
        });
    };
</script>
</body>
</html>